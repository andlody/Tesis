<!DOCTYPE html>
<html lang="es">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>Maestria UNI</title>
	<meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />
	<link rel="icon" href="public/img/icon.ico" type="image/x-icon"/>

	<!-- Fonts and icons -->
	<script src="public/js/plugin/webfont/webfont.min.js"></script>
	<script>
		WebFont.load({
			google: {"families":["Lato:300,400,700,900"]},
			custom: {"families":["Flaticon", "Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"], urls: ['public/css/fonts.min.css']},
			active: function() {
				sessionStorage.fonts = true;
			}
		});
	</script>

	<!-- CSS Files -->
	<link rel="stylesheet" href="public/css/bootstrap.min.css">
	<link rel="stylesheet" href="public/css/atlantis.css">

	<!-- CSS Just for demo purpose, don't include it in your project -->
	<link rel="stylesheet" href="public/css/demo.css">
	<style>
		.spinner {
			margin: 0px auto 0;
			width: 70px;
			text-align: center;
			}

			.spinner > div {
			width: 9px;
			height: 9px;
			background-color: #9a9a9a;

			border-radius: 100%;
			display: inline-block;
			-webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
			animation: sk-bouncedelay 1.4s infinite ease-in-out both;
			}

			.spinner .bounce1 {
			-webkit-animation-delay: -0.32s;
			animation-delay: -0.32s;
			}

			.spinner .bounce2 {
			-webkit-animation-delay: -0.16s;
			animation-delay: -0.16s;
			}

			@-webkit-keyframes sk-bouncedelay {
			0%, 80%, 100% { -webkit-transform: scale(0) }
			40% { -webkit-transform: scale(1.0) }
			}

			@keyframes sk-bouncedelay {
			0%, 80%, 100% { 
				-webkit-transform: scale(0);
				transform: scale(0);
			} 40% { 
				-webkit-transform: scale(1.0);
				transform: scale(1.0);
			}
			}

			textarea {
				background: #f9fbfd;
    			color: #750504;
				margin: 10px;
				min-height: 300px;
				font-family: "Lucida Console", Monaco, monospace;
				font-size: 0.8rem;
				line-height: 1.2;
				border: 1px solid #dbdbdb;
			}
	</style>
</head>
<body>
	<div class="wrapper">
		<div class="main-header">
			<!-- Logo Header -->
			<div class="logo-header" data-background-color="blue">
				
				<a href="./" class="logo">
					<span style="color: #fff;font-weight: 600;">UNI - MAESTRIA IA</span>
				</a>
				<button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse" data-target="collapse" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon">
						<i class="icon-menu"></i>
					</span>
				</button>
				<button class="topbar-toggler more"><i class="icon-options-vertical"></i></button>
				<div class="nav-toggle">
					<button class="btn btn-toggle toggle-sidebar">
						<i class="icon-menu"></i>
					</button>
				</div>
			</div>
			<!-- End Logo Header -->

			<!-- Navbar Header -->
			<nav class="navbar navbar-header navbar-expand-lg" data-background-color="blue2">
			</nav>
			<!-- End Navbar -->
		</div>

		<!-- Sidebar -->
		<div class="sidebar sidebar-style-2">			
			<div class="sidebar-wrapper scrollbar scrollbar-inner">
				<div class="sidebar-content">
					<div class="user">
						<div class="avatar-sm float-left mr-2">
							<img src="public/img/andree.png" alt="..." class="avatar-img rounded-circle">
						</div>
						<div class="info">
							<a data-toggle="collapse" href="#collapseExample" aria-expanded="true">
								<span>
									Andree Ochoa
									<span class="user-level">Administrator</span>
									<span class="caret"></span>
								</span>
							</a>
							<div class="clearfix"></div>

							<div class="collapse in" id="collapseExample">
								<ul class="nav">
									<li>
										<a href="#profile">
											<span class="link-collapse">Mi perfil</span>
										</a>
									</li>
									<li>
										<a href="#edit">
											<span class="link-collapse">Editar perfil</span>
										</a>
									</li>
									<li>
										<a href="#settings">
											<span class="link-collapse">Configuraciones</span>
										</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
					
				</div>
				<img src="public/img/uni.png" style="max-width: 200px;opacity: 0.15;margin-left: 25px;">
			</div>
			
		</div>
		<!-- End Sidebar -->

		<div class="main-panel">
			<div class="container container-full">
				<div class="page-wrapper has-sidebar">
					<div class="page-inner page-inner-fill">
						<div class="conversations">
							<div class="message-header">
								<div class="message-title">
									<div class="user ml-2">
										<div class="avatar avatar-online">
											<img src="public/img/boot.avif" alt="..." class="avatar-img rounded-circle border border-white">
										</div>
										<div class="info-user ml-2">
											<span class="name">Promart Boot</span>
											<span class="last-active">Activo</span>
										</div>
									</div>
									<div class="ml-auto">
										<button class="btn btn-light" onclick="eliminar()">
											<i class="fas fa-trash-alt"></i>
										</button>
										<button class="btn btn-light page-sidebar-toggler d-xl-none">
											<i class="fa fa-angle-double-left"></i>
										</button>
									</div>
								</div>
							</div>
							<div class="conversations-body">
								<div class="conversations-content bg-white">
								</div>
							</div>
							<div class="messages-form">
								<div class="messages-form-control">
									<input type="text" id="texto" placeholder="Escribe ..." class="form-control input-pill input-solid message-input">
								</div>
								<div class="messages-form-tool">
									<a href="javascript:void(0)" class="attachment" onclick="enviar()">
										<i class="fas fa-play"></i>
									</a>
								</div>
							</div>
						</div>
					</div>
					<div class="page-sidebar" style="background: #ffffff">
						<header class="sidebar-header d-xl-none">
							<a class="back">
								<i class="breadcrumb-icon fa fa-angle-left mr-2"></i>Back
							</a>
						</header>
						<div style="margin-left: 10px;margin-top: 10px;font-weight: 600;color: #3b3b3b;">Request:</div>
						<textarea name="" id="request" cols="30" rows="10"></textarea>
						<div style="margin-left: 10px;margin-top: 10px;font-weight: 600;color: #3b3b3b;">Response:</div>
						<textarea name="" id="response" cols="30" rows="10"></textarea>
					</div>
				</div>
			</div>
		</div>


	</div>
	<!--   Core JS Files   -->
	<script src="public/js/core/jquery.3.2.1.min.js"></script>
	<script src="public/js/core/popper.min.js"></script>
	<script src="public/js/core/bootstrap.min.js"></script>
	<!-- jQuery UI -->
	<script src="public/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
	<script src="public/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
	<!-- Bootstrap Toggle -->
	<script src="public/js/plugin/bootstrap-toggle/bootstrap-toggle.min.js"></script>
	<!-- jQuery Scrollbar -->
	<script src="public/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
	<!-- Atlantis JS -->
	<script src="public/js/atlantis.min.js"></script>
	<!-- Atlantis DEMO methods, don't include it in your project! -->
	<script src="public/js/setting-demo.js"></script>

	<script>
		$("#texto").on('keyup', function (e) {if (e.key === 'Enter' || e.keyCode === 13) {enviar()}});

		const getHora = () => {
			date = new Date()
			hora = date.getHours()
			minutos = date.getMinutes()
			segundos = date.getSeconds()
			if (hora < 10) hora = '0' + hora;
			if (minutos < 10) minutos = "0" + minutos;
			if (segundos < 10) segundos = "0" + segundos;
			return hora+':'+minutos+':'+segundos
		}

		let history=[]
		const enviar = () => {
			texto = $('#texto').val().trim()
			if(texto=='') return;

			printUser(texto)
			$('#texto').val('')

			loadingBoot()
			
			let bodyJson = {pregunta:texto, k:5, history:history}
			printReqRes(bodyJson,'request')
			let URL = 'https://617d01458ed3.ngrok-free.app'
			//let URL = 'http://127.0.0.1:8000'
			fetch(URL+'/clasificar',{
				method: "POST",
				body: JSON.stringify(bodyJson),
				headers: {'Content-Type': 'application/json'},
			}).then((response) => {
				if(response.ok) return response.json();
				throw new Error('Something went wrong');
			})
			.then((json) => { 
				printReqRes(json,'response')
				$('#eliminar').remove()
				console.log(json)
				printBoot(json.respuesta)

				history.push({role:'user',content:texto})
				history.push({role:'boot',content:json.respuesta})
			})
			.catch((error) => {
				$('#eliminar').remove()
				$('.conversations-content').append('<span style="color:red">Ocurrio un error: </div>')
				$('.conversations-content').append(error)
				console.error(error)
			});
		}

		const printUser = (texto) => {
			$('.conversations-content').append(
				`<div class="message-content-wrapper">
					<div class="message message-out">
						<div class="message-body">
							<div class="message-content">
								<div class="content">
									`+texto+`
								</div>
							</div>
							<div class="date">`+getHora()+`</div>
						</div>
					</div>
				</div>`)
			scroll()
		}

		const loadingBoot = () => {
			$('.conversations-content').append(
				`<div class="message-content-wrapper" id="eliminar">
					<div class="message message-in">
						<div class="avatar avatar-sm">
							<img src="public/img/boot.avif" class="avatar-img rounded-circle border border-white">
						</div>
						<div class="message-body">
							<div class="message-content">
								<div class="content">
									<div class="spinner">
										<div class="bounce1"></div>
										<div class="bounce2"></div>
										<div class="bounce3"></div>
									</div>
								</div>
							</div>	
						</div>
					</div>
				</div>`)
			scroll()
		}

		const printBoot = (texto) => {
			$('.conversations-content').append(
				`<div class="message-content-wrapper">
					<div class="message message-in">
						<div class="avatar avatar-sm">
							<img src="public/img/boot.avif" class="avatar-img rounded-circle border border-white">
						</div>
						<div class="message-body">
							<div class="message-content">
								<div class="content">`+texto+`</div>
							</div>
							<div class="date">`+getHora()+`</div>
						</div>
					</div>
				</div>`)
			scroll()
		}

		const scroll = () => {
			$('.conversations-body').scrollTop( $('.conversations-body').prop('scrollHeight') )
		}

		const eliminar = () => {
			history=[]
			$('.conversations-content').html('')
			$('#request').text('')
			$('#response').text('')
			printBoot('Bienvenido, en que puedo ayudarte?')
		}
		eliminar()

		const printReqRes = (json,tipo) => {
			if(tipo=='request') $('#response').text('')
			let formattedJson = JSON.stringify(json, null, 2);
			$('#'+tipo).text(formattedJson);
		}
	</script>
</body>
</html>